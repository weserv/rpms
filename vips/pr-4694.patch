From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Lovell Fuller <lovell@users.noreply.github.com>
Date: Fri, 10 Oct 2025 13:51:42 +0100
Subject: [PATCH 1/1] svgload: ignore short/malformed compressed input (#4694)

Checks for end of stream inside loop

Co-authored-by: Kleis Auke Wolthuizen <github@kleisauke.nl>

Upstream-Status: Backport [https://github.com/libvips/libvips/commit/faa16468621d7ad885ee202e57091603aa1a7208]

diff --git a/libvips/foreign/svgload.c b/libvips/foreign/svgload.c
index 1111111..2222222 100644
--- a/libvips/foreign/svgload.c
+++ b/libvips/foreign/svgload.c
@@ -272,6 +272,7 @@ vips_foreign_load_svg_is_a(const void *buf, size_t len)
 		str[1] == '\213') {
 		z_stream zs;
 		size_t opos;
+		int err;
 
 		zs.zalloc = (alloc_func) vips_foreign_load_svg_zalloc;
 		zs.zfree = (free_func) vips_foreign_load_svg_zfree;
@@ -288,11 +289,18 @@ vips_foreign_load_svg_is_a(const void *buf, size_t len)
 		do {
 			zs.avail_out = sizeof(obuf) - opos;
 			zs.next_out = (unsigned char *) obuf + opos;
-			if (inflate(&zs, Z_NO_FLUSH) < Z_OK) {
+			err = inflate(&zs, Z_NO_FLUSH);
+
+			/* Always update opos after inflate(), even if stream ended.
+			 */
+			opos = sizeof(obuf) - zs.avail_out;
+
+			if (err == Z_STREAM_END)
+				break;
+			if (err != Z_OK) {
 				inflateEnd(&zs);
 				return FALSE;
 			}
-			opos = sizeof(obuf) - zs.avail_out;
 		} while (opos < sizeof(obuf) &&
 			zs.avail_in > 0);
 
